pipeline {
    agent none
    stages {
        stage ('Get Code'){
            agent {
                label 'principal'
            }
            steps {
                sh 'echo "******************"'
                sh 'hostname'
                sh 'whoami'
                sh 'echo "******************"'
                //Optenemos el codigo de nuestro Git
                git 'http://github.com/santife/helloworld.git'
                stash name: 'archivos', includes: '**/*'
            }
        }
        
        stage ('Build') {
            agent {
                label 'principal'
            }
            steps {
                sh 'echo "******************"'
                sh 'hostname'
                sh 'whoami'
                sh 'echo "******************"'
                echo WORKSPACE
                sh 'hostname'
                sh 'ls -lrt'
            }
        }
        stage ('test'){
            parallel {
                stage('unit') {
                    agent {
                        label 'linux1'
                    }
                    steps {
                        unstash 'archivos'
                        sh 'echo "******************"'
                        sh 'hostname'
                        sh 'whoami'
                        sh 'echo "******************"'
                        sh '''
                            export PYTHONPATH=$(pwd)
                            pytest --junitxml=result_unit.xml test/unit
                    '''
                    stash name: 'xmlUnit'
                    }
                }
                
                stage('Rest') {
                    agent {
                        label 'linux2'
                    }
                    steps {
                        sh 'echo "******************"'
                        sh 'hostname'
                        sh 'whoami'
                        sh 'echo "******************"'
                        unstash 'archivos'
                        sh '''
                            export FLASK_APP=app/api.py
                            export FLASK_ENV=development
                            flask run &
                            java -jar /var/lib/jenkins/workspace/wiremock-standalone-3.3.1.jar --port 9090 --root-dir test/wiremock/ &
                            sleep 3
                            export PYTHONPATH=$(pwd)
                            pytest --junitxml=result_rest.xml test/rest
                        '''
                        stash name: 'xmlRest'
                    }
                }
            }
        }
        
        stage ('Result') {
            agent {
                label 'principal'
            }
            steps {
                sh 'echo "******************"'
                sh 'hostname'
                sh 'whoami'
                sh 'echo "******************"'
                unstash 'xmlUnit'
                unstash 'xmlRest'
                junit 'result*.xml'
            }
        }

    }
}
